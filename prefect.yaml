# prefect.yaml

# The pull section contains instructions for the worker at runtime.
pull:
  - prefect.deployments.steps.git_clone:
      id: clone-repo
      repository: https://github.com/AloisCRR/repossessed-assets.git
      branch: main

  - prefect.deployments.steps.pip_install_requirements:
      directory: "{{ clone-repo.directory }}"
      requirements_file: requirements.txt

# Definitions section for reusable configurations
definitions:
  work_pools:
    local_pool: &local_pool
      name: local-pool
      work_queue_name: default

  schedules:
    hourly: &hourly
      interval: 3600
      timezone: "UTC"
    
    daily: &daily
      interval: 86400
      timezone: "UTC"
    
    weekly: &weekly
      interval: 604800
      timezone: "UTC"

  tags:
    scraping: &scraping_tags
      - etl
      - scraping

deployments:
  - name: global-bank-repossessed-assets-deployment
    description: A flow that fetches Global Bank repossessed assets links, deployed via YAML.
    tags: 
      - *scraping_tags
      - global-bank
    entrypoint: global_bank.py:global_bank_repossessed_assets
    work_pool: *local_pool
    # Add schedule here if needed, e.g.:
    schedule: *daily
    concurrency_limit:
      limit: 5
      collision_strategy: ENQUEUE
    # Add environment variables here if needed, e.g.:
    # job_variables:
    #   env:
    #     GLOBAL_BANK_API_KEY: "{{ prefect.blocks.secret.global-bank-api-key }}"

  - name: banco-general-repossessed-assets-deployment
    description: A flow that fetches Banco General repossessed assets links and scrapes property data, deployed via YAML.
    tags: 
      - *scraping_tags
      - banco-general
    entrypoint: banco_general.py:banco_general_repossessed_assets
    work_pool: *local_pool
    schedule: *daily
    concurrency_limit:
      limit: 5
      collision_strategy: ENQUEUE

  - name: caja-de-ahorros-repossessed-assets-deployment
    description: A flow that fetches Caja de Ahorros repossessed assets links and scrapes property data, deployed via YAML.
    tags: 
      - *scraping_tags
      - caja-de-ahorros
    entrypoint: caja_de_ahorros.py:caja_de_ahorros_repossessed_assets
    work_pool: *local_pool
    schedule: *daily
    concurrency_limit:
      limit: 5
      collision_strategy: ENQUEUE

  - name: reprocess-stale-links-deployment
    description: A flow that reprocesses stale repossessed assets links and updates property data, deployed via YAML.
    tags: 
      - *scraping_tags
      - maintenance
    entrypoint: stale_links_processor.py:reprocess_stale_links
    work_pool: *local_pool
    schedule: *weekly
    concurrency_limit:
      limit: 3
      collision_strategy: ENQUEUE